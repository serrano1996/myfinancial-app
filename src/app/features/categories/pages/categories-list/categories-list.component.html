<div class="page-container">
    <header class="page-header flex justify-between items-center">
        <div>
            <h1>{{ 'CATEGORIES.TITLE' | translate }}</h1>
            <p class="subtitle">{{ 'CATEGORIES.SUBTITLE' | translate }}</p>
        </div>
        <button class="btn btn-primary" (click)="openCreateModal()">
            <span>+ {{ 'CATEGORIES.ADD_BUTTON' | translate }}</span>
        </button>
    </header>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
    </div>

    <div *ngIf="!loading" class="categories-content">

        <ng-container *ngFor="let type of ['income', 'expense', 'savings']">
            <section class="category-section" *ngIf="groupedCategories[type] && groupedCategories[type].length > 0">
                <h2 class="section-title">{{ ('CATEGORIES.MODAL.TYPES.' + (type | uppercase)) | translate }}</h2>

                <div class="category-tree">
                    <!-- Recursive Template -->
                    <ng-template #nodeTemplate let-nodes="nodes">
                        <div *ngFor="let node of nodes" class="category-node-wrapper">
                            <div class="category-node card" (click)="openEditModal(node, $event)">
                                <div class="node-content">
                                    <div class="category-icon" [style.background-color]="node.color + '20'"
                                        [style.color]="node.color">
                                        {{ node.icon || 'üè∑Ô∏è' }}
                                    </div>
                                    <span class="category-name">
                                        {{ (translate.currentLang === 'en' && node.name_en) ? node.name_en : node.name
                                        }}
                                    </span>
                                </div>

                                <div class="node-actions">
                                    <button class="btn-icon delete-btn" (click)="deleteCategory(node.id, $event)"
                                        [title]="'COMMON.DELETE' | translate">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path
                                                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Children -->
                            <div *ngIf="node.children && node.children.length > 0" class="node-children">
                                <ng-container
                                    *ngTemplateOutlet="nodeTemplate; context:{nodes: node.children}"></ng-container>
                            </div>
                        </div>
                    </ng-template>

                    <ng-container
                        *ngTemplateOutlet="nodeTemplate; context:{nodes: groupedCategories[type]}"></ng-container>
                </div>
            </section>

            <!-- Empty State Per Section if needed, but overall empty state below -->
        </ng-container>

        <!-- Overall Empty State -->
        <div *ngIf="categories.length === 0" class="empty-state">
            <p>{{ 'CATEGORIES.EMPTY' | translate }}</p>
        </div>
    </div>

    <app-category-form-modal [visible]="showModal" [category]="editingCategory" [categories]="categories"
        [loading]="modalLoading" (save)="handleSave($event)" (cancel)="closeModal()"></app-category-form-modal>
</div>